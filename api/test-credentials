// api/test-credentials.js
// Test endpoint to verify credentials are set correctly

module.exports = async (req, res) => {
  res.setHeader('Access-Control-Allow-Origin', '*');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  const checks = {
    envVarExists: !!process.env.GOOGLE_SERVICE_ACCOUNT,
    envVarLength: process.env.GOOGLE_SERVICE_ACCOUNT ? process.env.GOOGLE_SERVICE_ACCOUNT.length : 0,
    canParse: false,
    hasPrivateKey: false,
    hasClientEmail: false,
    clientEmail: null
  };

  if (checks.envVarExists) {
    try {
      const creds = JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT);
      checks.canParse = true;
      checks.hasPrivateKey = !!creds.private_key;
      checks.hasClientEmail = !!creds.client_email;
      checks.clientEmail = creds.client_email;
    } catch (e) {
      checks.parseError = e.message;
    }
  }

  return res.status(200).json({
    status: 'Credentials Check',
    checks: checks,
    recommendation: checks.hasPrivateKey && checks.hasClientEmail 
      ? 'Credentials look valid!' 
      : 'Credentials are missing required fields'
  });
};
